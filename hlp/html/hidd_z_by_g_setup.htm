<html>
  <head>
    <title>Eucentricity by Fcous Setup Dialog</title>
    <meta HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252"/>
    <style type="text/css"> <!-- BODY { font-family:"Arial" }
  TD { font-size:16 }
      .style1
      {
        font-size: larger;
        font-weight: bold;
      }
      --></style>
  </head>
  <body BGCOLOR="#ffffff" TEXT="#000000">
    <basefont size="2">
    <p><a NAME="hidd_z_by_g_setup"></a><span class="style1">Eucentricity by Focus Setup
        Dialog</span></p>
    <p> This dialog lets you make calibrations needed for the Eucentricity by Focus 
      routine and set a few parameters controlling how the procedure runs.&nbsp; The 
      routine finds the eucentric point by setting a particular absolute focus value 
      (objective lens strength), measuring defocus with beam-tilted images, and 
      adjusting the Z height to bring the measured defocus to the same same value that 
      it had when the microscope was eucentric with that same absolute focus value.&nbsp; 
      (This procedure has been commonly referred to as &#39;Z by G&#39; and Chen Xu has 
      distributed a script by that name.) The point of the calibration procedure here is to measure the defocus and read the 
      absolute focus from the microscope when the specimen is known to be eucentric.&nbsp; 
      This measurement can be done at a preferred defocus and/or with a defocus offset 
      to make it more reliable.&nbsp; Before the calibration, the stage is moved in Z 
      to establish backlash from below if necessary. The Eucentricity by Focus routine 
      itself does all Z moves with the same direction of backlash.</p>
    <p> &nbsp;The relation between defocus at eucentricity and absolute focus is 
      magnification dependent, so separate calibrations are stored for different 
      magnifications.&nbsp; At a given magnification, there can also be separate 
      calibrations for different cameras, and for three different states: Low Dose 
      Focus, Low Dose View, and not in Low Dose mode.&nbsp; These calibrations are 
      stored in the settings file, not in the calibrations file.</p>
    <p> &nbsp;To make the defocus measurements as reproducible as possible, the 
      illumination conditions are stored (intensity, spot size, and probe mode or 
      alpha) as well as the defocus offset and beam tilt used in the measurement.&nbsp; 
      The top line of the dialog shows the current camera and which of the three Low 
      Dose states applies.&nbsp; Below that is a summary of the relevant conditions.&nbsp; 
      On the left are the current values from the microscope and program.&nbsp; On the 
      right, if there is a stored calibration matching the magnification, camera, and 
      Low Dose state, are the stored values.&nbsp; You can run the calibration either 
      with the current or the stored scope settings. Here are some relevant points:</p>
    <ul>
      <li>The Low Dose state will show up as View if the program is in View, otherwise 
        as Focus, because that is the area that will be used for focus measurement.</li>
      <li>If there is no calibration, the Magnification line will say either 'No cals 
        for cam and LD', meaning that there are none matching the camera and Low Dose 
        state, or 'No cal, nearest at X', where X is the nearest magnification with a 
        matching calibration.</li>
      <li>Eucentricity by Focus can still be run if the stored intensity differs from 
        the current one, regardless of Low Dose State.</li>
      <li>In Low Dose mode, the stored spot size and probe mode or alpha can also be 
        different from the current values, but (at least for now) these values must 
        match in order to run the procedure.</li>
      <li>In View mode, the current 'Focus offset' shown is the sum of the View focus 
        offset and the defocus offset used in defocus measurement.&nbsp; The calibrated 
        value is the net offset that will be used.</li>
      <li>The <strong>Update State</strong> button should be used to refresh the current 
        values if you change some settings.&nbsp; The program will automatically update 
        the dialog when the Low Dose state is changed, but not otherwise.&nbsp; It will, 
        however, update the settings first before running a calibration.</li>
      <li>You </li>
    </ul>
    <p>
      <strong><em>Controls Relevant to the Calibration:</em></strong></p>
    <p>
      <strong>Calibrate with focus offset of</strong></p>
    <p>
      Turn on the check box and enter an alternative value for the focus offset to use 
      in a calibration.&nbsp; For measuring with View, this offset overrides both the 
      View focus offset and the autofocus focus offset.</p>
    <p>
      <strong>Calibrate with beam tilt of </strong>
    </p>
    <p>
      Turn on this check box and enter an alternative value for the beam tilt to apply 
      when measuring defocus.&nbsp; You may well want a higher value for focusing with 
      View, to yield larger displacements that can be measured more accurately.</p>
    <p>
      Calibrate with <strong>Current Settings</strong></p>
    <p>
      Press this button to run a calibration with the current settings, possibly 
      overridden by entries for focus offset and beam tilt.&nbsp; The calibration will 
      simply measure defocus 3 times and store the average result.&nbsp; If there is 
      an existing calibration shown, it will be replaced by the new one; otherwise, a 
      new calibration is stored.</p>
    <p>
      Calibrate with <strong>Stored Settings</strong></p>
    <p> This button is enabled if there is a calibration shown for the current 
      conditions, except that it will be disabled when not in Low Dose mode if the 
      spot size or probe mode or alpha do not match the current conditions.&nbsp; 
      Press it to run with the stored settings, possibly overridden by entries for 
      focus offset and beam tilt.&nbsp; The calibrations will replace the existing 
      one.</p>
    <p> <strong><em>Controls Relevant when Running Eucentricity by Focus:</em></strong></p>
    <p> <strong>Use View area in Low Dose mode</strong></p>
    <p> The checkbox controls whether the Eucentricity by Focus routine will measure 
      defocus with View or Focus in Low Dose mode.&nbsp; There must be a calibration 
      for whichever area will be used.</p>
    <p> <strong>Maximum total change in Z</strong></p>
    <p> The Eucentricity by Focus routine will stop with an error and restore the 
      original Z position if the change in Z implied by the latest defocus measurement 
      would result in the total change in Z exceeding this amount.&nbsp; This entry is 
      intended to provide some protection against wild defocus values being measured 
      on a bad specimen area.&nbsp; However,because of the nonlinear relationship 
      between Z and defocus, the entry may need to be considerably larger than the 
      actual Z change for it not to fail on large Z changes.&nbsp; This depends on how 
      well the nonlinearities are accounted for in the procedure (see below).&nbsp; 
      For example, an entry of 140 may be needed to allow for 100 micron changes.</p>
    <p> <strong>Threshold Z change for iterating</strong></p>
    <p> The routine will iterate up to 5 times as long as the defocus difference from 
      the target value is bigger than the threshold value set here.&nbsp; The default 
      value is 0.5 microns; a smaller value might be appropriate if stage moves are 
      quite accurate, whereas a larger value might be needed if they are relatively 
      inaccurate.</p>
    <p> <em><strong>Calibrating Nonlinearity for Better Predictability and 
      Convergence:</strong></em></p>
    <p> The dependence of measured defocus on Z height is highly nonlinear at large 
      distances from eucentricity.&nbsp; You can ignore this effect if you are only 
      going to use Eucentricity by Focus over short distances, as a replacement for 
      Fine Eucentricity, but if you are going to use it over distances up to 100 
      microns, it will work better with some compensation.&nbsp; On a Tecnai F30, these values were found:</p>
    <pre>
     Z     Defocus
   -110     -75
   -100     -70
    100     157
    110     180
</pre>
    <p>At underfocus, i.e., from large negative Z, the first iteration will not move the stage nearly enough, 
      but later iterations will be much more effective.&nbsp; At overfocus, from large 
      positive Z, the first iteration is in danger of moving the stage much too far; 
      this will work out after two more iterations, but would require a large entry 
      for the maximum allowed Z change.&nbsp; To reduce these effects, the program 
      allows a property entry, ZbgGFocusScalings, with a set of values indicating how 
      to scale a measured defocus into a Z change when defocus is more extreme than a 
      given amount.&nbsp; The default value of this property is '100 0.7', which 
      applies a scaling of 0.7 to any measured focus above 100, and should prevent the 
      worst effects at positive Z for scopes with the same kind of behavior as the 
      F30.&nbsp; An entry of '-70 1.3 100 0.72 150 0.64' would boost measurements 
      below -70 microns by 1.3, reduce ones between 100 and 150 microns by 0.72 
      between 100 and 150 microns, and reduce ones above 150 microns by 0.64 . Below 
      is a script that can assess the dependence at a range of Z heights. You can 
      change the collection of Z values to fit your situation.&nbsp; It is best to do 
      this outside of Low Dose mode, at a moderate magnification, and with full-field 
      Focus images.&nbsp; be sure that the beam is big enough over the whole Z range 
      and watch the autofocusing to make sure that the image displacements do not 
      become too large. If the pairs of values, defocus and scaling, appear 
      reasonable, insert the final line of output into the properties file.</p>


<pre>
delZarr = { -120 -100 -80 -50 50 80 100 120 }
numZ = $#delZarr
ReportStageXYZ sx sy sz
loop $numZ ind
   delZ = $delZarr[$ind]
   MoveStageTo $sx $sy $sz + $delZ
   Autofocus -1 0
   ReportAutofocus def
  defInt = ROUND ( $def 0 )
  scale =  ROUND ( $delZ / $def 2 )
  if $ind > 0
     scaleArr = { $scaleArr $defInt $scale }
  Else
     scaleArr = { $defInt $scale }
  Endif 
EndLoop 
echo ZbyGFocusScalings $scaleArr
</pre>

  </body>
</html>
